# file: 10630.t 
# author: Jing Xu(Lee)
# email: leexu@hengtiansoft.com
# date: Apr 12, 2013
# description:

#!/usr/bin/perl

use strict;
use warnings;

use FindBin qw($Bin);
use lib "$Bin/../../wrapper/lib";
use Fdftest::Fdfapi;
use Fdftest::Node;
use Fdftest::TestCase;
use Test::More tests => 38;

my $node;

sub test_run {

    my $ret;
    my $cguid;
    my (@cntr_array, %stats_hash, $slab_gc_segments_compacted, $slab_gc_segments_freed);
    my $nops = 32768 * 5;

    $ret = $node->start (ZS_REFORMAT => 1,);
    like ($ret, qr/OK.*/, 'Node start');

    $ret = OpenContainer ($node->conn (0), "cntr0", "ZS_CTNR_CREATE", 450559, 4, "ZS_DURABILITY_PERIODIC", "no");
    $cguid = $1 if ($ret =~ /OK cguid=(\d+)/);

    WriteReadObjects ($node->conn (0), $cguid, 1, 250, 1, 1500, $nops,
        "ZS_WRITE_MUST_NOT_EXIST");

    foreach (0 .. 9) {
        my $keyoff = $_ * $nops / 10 + 1;
        DeleteObjects ($node->conn (0), $cguid, $keyoff, 250, $nops / 20);
    }

    sleep(30);

    @cntr_array = $node->dump_zsstats_log ();
    %stats_hash = $node->get_details_hash  ();

    $slab_gc_segments_compacted =
        $stats_hash{'Overall ZS Statistics'}{'Flash statistics'}{'slab_gc_segments_compacted'};
    $slab_gc_segments_freed = $stats_hash{'Overall ZS Statistics'}{'Flash statistics'}{'slab_gc_segments_freed'};
    is ($slab_gc_segments_compacted, 3, "Compact $slab_gc_segments_compacted segments ");
    is ($slab_gc_segments_freed,     3, "Free segment list count is $slab_gc_segments_freed");

    foreach (0 .. 9) {
        my $keyoff = $_ * $nops / 10 + 1;
        WriteReadObjects (
            $node->conn (0),
            $cguid, $keyoff, 250, 1, 1500,
            $nops / 20, "ZS_WRITE_MUST_NOT_EXIST"
        );
    }

    CloseContainer ($node->conn (0), $cguid);
    DeleteContainer ($node->conn (0), $cguid);

    return;
}

sub test_init {
    $node = Fdftest::Node->new (
        ip    => "127.0.0.1",
        port  => "24422",
        nconn => 1,
    );

}

sub test_clean {
    $node->stop ();
    $node->set_ZS_prop (ZS_REFORMAT => 1);

    return;
}

#
# main
#
{
    test_init ();

    test_run ();

    test_clean ();
}

# clean ENV
END {
    $node->clean ();
}

